
-- CRIAÇÃO DAS TABELAS

CREATE TABLE SETOR (
    SET_IDPK INTEGER PRIMARY KEY,
    SET_NOME VARCHAR2(100),
    SET_LIMITE_CONSUMO_KWH NUMBER
);

CREATE TABLE EQUIPAMENTO (
    EQU_IDPK INTEGER PRIMARY KEY,
    EQU_NOME VARCHAR2(100),
    EQU_SETOR_IDPK INTEGER,
    EQU_POTENCIA_KW NUMBER,
    FOREIGN KEY (EQU_SETOR_IDPK) REFERENCES SETOR(SET_IDPK)
);

CREATE TABLE CONSUMO_ENERGIA (
    CEN_IDPK INTEGER PRIMARY KEY,
    CEN_EQUIPAMENTO_IDPK INTEGER,
    CEN_DATA_CONSUMO DATE,
    CEN_CONSUMO_KWH NUMBER,
    FOREIGN KEY (CEN_EQUIPAMENTO_IDPK) REFERENCES EQUIPAMENTO(EQU_IDPK)
);

CREATE TABLE ALERTA_ENERGIA (
    AEN_IDPK INTEGER PRIMARY KEY,
    AEN_SETOR_IDPK INTEGER,
    AEN_DATA_ALERTA DATE,
    AEN_CONSUMO_KWH NUMBER,
    AEN_LIMITE_KWH NUMBER,
    AEN_MENSAGEM VARCHAR2(255),
    FOREIGN KEY (AEN_SETOR_IDPK) REFERENCES SETOR(SET_IDPK)
);

CREATE TABLE MANUTENCAO_PREVENTIVA (
    MPR_IDPK INTEGER PRIMARY KEY,
    MPR_EQUIPAMENTO_IDPK INTEGER,
    MPR_DATA_MANUTENCAO DATE,
    MPR_TIPO_MANUTENCAO VARCHAR2(100),
    STATUS VARCHAR2(20),
    FOREIGN KEY (MPR_EQUIPAMENTO_IDPK) REFERENCES EQUIPAMENTO(EQU_IDPK)
);

CREATE TABLE CONSUMO_RESUMO_SETOR (
    CRS_IDPK INTEGER PRIMARY KEY,
    CRS_SETOR_IDPK INTEGER,
    CRS_DATA_RESUMO DATE,
    CRS_TOTAL_CONSUMO_KWH NUMBER
);

-- SEQUÊNCIAS (FICTÍCIAS)
CREATE SEQUENCE SEQ_ALERTA_ENERGIA START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE SEQ_MANUTENCAO START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE SEQ_RESUMO_SETOR START WITH 1 INCREMENT BY 1;

-- TRIGGERS E PROCEDURES

-- GERAÇÃO DE ALERTA AUTOMÁTICO
CREATE OR REPLACE TRIGGER TRG_GERAR_ALERTA
AFTER INSERT ON CONSUMO_ENERGIA
FOR EACH ROW
DECLARE
    V_LIMITE NUMBER;
    V_IDSETOR INTEGER;
BEGIN
    SELECT EQU_SETOR_IDPK INTO V_IDSETOR
    FROM EQUIPAMENTO
    WHERE EQU_IDPK = :NEW.CEN_EQUIPAMENTO_IDPK;

    SELECT SET_LIMITE_CONSUMO_KWH INTO V_LIMITE
    FROM SETOR
    WHERE SET_IDPK = V_IDSETOR;

    IF :NEW.CEN_CONSUMO_KWH > V_LIMITE THEN
        INSERT INTO ALERTA_ENERGIA (
            AEN_IDPK, AEN_SETOR_IDPK, AEN_DATA_ALERTA, AEN_CONSUMO_KWH, AEN_LIMITE_KWH, AEN_MENSAGEM
        ) VALUES (
            SEQ_ALERTA_ENERGIA.NEXTVAL, V_IDSETOR, :NEW.CEN_DATA_CONSUMO,
            :NEW.CEN_CONSUMO_KWH, V_LIMITE,
            'Consumo ultrapassou limite sustentável.'
        );
    END IF;
END;
/

-- AGENDAMENTO AUTOMÁTICO DE MANUTENÇÃO PREVENTIVA
CREATE OR REPLACE TRIGGER TRG_AGENDAR_MANUTENCAO
AFTER INSERT ON CONSUMO_ENERGIA
FOR EACH ROW
DECLARE
    V_POTENCIA NUMBER;
BEGIN
    SELECT EQU_POTENCIA_KW INTO V_POTENCIA
    FROM EQUIPAMENTO
    WHERE EQU_IDPK = :NEW.CEN_EQUIPAMENTO_IDPK;

    IF :NEW.CEN_CONSUMO_KWH > (V_POTENCIA * 10) THEN
        INSERT INTO MANUTENCAO_PREVENTIVA (
            MPR_IDPK, MPR_EQUIPAMENTO_IDPK, MPR_DATA_MANUTENCAO, MPR_TIPO_MANUTENCAO, STATUS
        ) VALUES (
            SEQ_MANUTENCAO.NEXTVAL, :NEW.CEN_EQUIPAMENTO_IDPK, SYSDATE + 7,
            'Verificação por alto consumo', 'Pendente'
        );
    END IF;
END;
/

-- STATUS AUTOMÁTICO DE MANUTENÇÃO COMO "PENDENTE"
CREATE OR REPLACE TRIGGER TRG_STATUS_MANUTENCAO
BEFORE INSERT ON MANUTENCAO_PREVENTIVA
FOR EACH ROW
BEGIN
    :NEW.STATUS := 'Pendente';
END;
/

-- RESUMO AUTOMÁTICO DIÁRIO DE CONSUMO POR SETOR
CREATE OR REPLACE PROCEDURE RESUMO_CONSUMO_DIARIO AS
BEGIN
    INSERT INTO CONSUMO_RESUMO_SETOR (
        CRS_IDPK, CRS_SETOR_IDPK, CRS_DATA_RESUMO, CRS_TOTAL_CONSUMO_KWH
    )
    SELECT 
        SEQ_RESUMO_SETOR.NEXTVAL,
        RESUMO.CRS_SETOR_IDPK,
        RESUMO.CRS_DATA_RESUMO,
        RESUMO.CRS_TOTAL_CONSUMO_KWH
    FROM (
        SELECT 
            EQU.EQU_SETOR_IDPK AS CRS_SETOR_IDPK,
            TRUNC(CEN.CEN_DATA_CONSUMO) AS CRS_DATA_RESUMO,
            SUM(CEN.CEN_CONSUMO_KWH) AS CRS_TOTAL_CONSUMO_KWH
        FROM CONSUMO_ENERGIA CEN
        JOIN EQUIPAMENTO EQU ON EQU.EQU_IDPK = CEN.CEN_EQUIPAMENTO_IDPK
        GROUP BY EQU.EQU_SETOR_IDPK, TRUNC(CEN.CEN_DATA_CONSUMO)
    ) RESUMO;
END;
/

-- INSERTS DE EXEMPLO
INSERT INTO SETOR VALUES (1, 'TI', 800);
INSERT INTO SETOR VALUES (2, 'Produção', 3000);
INSERT INTO SETOR VALUES (3, 'Administrativo', 600);

INSERT INTO EQUIPAMENTO VALUES (1, 'Servidor X', 1, 2);
INSERT INTO EQUIPAMENTO VALUES (2, 'Cafeteira', 1, 0.2);
INSERT INTO EQUIPAMENTO VALUES (3, 'Compressor Industrial', 2, 10);
INSERT INTO EQUIPAMENTO VALUES (4, 'Maquina de embalagem', 2, 15);
INSERT INTO EQUIPAMENTO VALUES (5, 'Ar-condicionado', 3, 1.5);
INSERT INTO EQUIPAMENTO VALUES (6, 'Geladeira', 3, 0.5);

INSERT INTO CONSUMO_ENERGIA VALUES (1, 1, SYSDATE, 480);
INSERT INTO CONSUMO_ENERGIA VALUES (2, 3, SYSDATE, 1100);
INSERT INTO CONSUMO_ENERGIA VALUES (3, 5, SYSDATE, 350);
INSERT INTO CONSUMO_ENERGIA VALUES (4, 3, SYSDATE, 50);
INSERT INTO CONSUMO_ENERGIA VALUES (5, 1, SYSDATE, 20);
INSERT INTO CONSUMO_ENERGIA VALUES (6, 2, SYSDATE, 100);
INSERT INTO CONSUMO_ENERGIA VALUES (7, 4, SYSDATE, 3100);
INSERT INTO CONSUMO_ENERGIA VALUES (8, 6, SYSDATE, 390);

EXEC RESUMO_CONSUMO_DIARIO;
