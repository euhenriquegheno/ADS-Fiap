CREATE OR REPLACE PROCEDURE PRC_DB_ATUALIZA_VL_TOT_PEDIDO (
    P_NR_LOJA DB_PEDIDO.NR_LOJA%TYPE, 
	P_NR_PEDIDO DB_PEDIDO.NR_PEDIDO%TYPE
) IS
	-- OS PARÂMETROS UTILIZAM O CONCEITO DE HERANÇA DOS TIPOS DE DADOS
	--
	-- VARIÁVEL CXRIADA NA SEÇÃO DE DECLARAÇÃO QUE IRÁ
	-- RECEBER O VALOR TOTAL DA CONSULTA SQL.
	V_VL_TOT_PEDIDO DB_PEDIDO.VL_TOT_PEDIDO%TYPE;
BEGIN
    
	SELECT  SUM(IP.QT_PEDIDO * IP.VL_UNITARIO) VAL_TOT_PEDIDO
	INTO 	V_VL_TOT_PEDIDO
	FROM    DB_ITEM_PEDIDO IP
	WHERE 	IP.NR_LOJA = P_NR_LOJA
	AND		IP.NR_PEDIDO = P_NR_PEDIDO;
	
	IF SQL%ROWCOUNT  > 0 THEN
		-- ATUALIZA A QUANTIDADE DE ESTRELAS DE UM DETERMINADO CLIENTE
		UPDATE DB_PEDIDO
		SET VL_TOT_PEDIDO = V_VL_TOT_PEDIDO
		WHERE NR_LOJA = P_NR_LOJA
		AND	NR_PEDIDO = P_NR_PEDIDO;
		DBMS_OUTPUT.PUT_LINE('A LOJA(' || P_NR_LOJA || ') E O PEDIDO (' || P_NR_PEDIDO || ') TEM O VALOR TOTAL A SER PAGO DE:' || V_VL_TOT_PEDIDO);
		-- CONFIRMA A TRANSAÇÃO ABERTA
		COMMIT;
	ELSE
		DBMS_OUTPUT.PUT_LINE('A LOJA(' || P_NR_LOJA || ') NÃO POSSUI O PEDIDO (' || P_NR_PEDIDO || ') CADASTRADO!');
	END IF;
	
EXCEPTION
	-- CASO ENCONTRE ALGUM ERRO, ESTE SERÁ CAPTURADO E O PROCESSAMENTO SERÁ ENCERRADO.
    WHEN OTHERS THEN
        RAISE_APPLICATION_ERROR(-20005, 'ERRO CRÍTICO NA ATUALIZAÇÃO DO PEDIDO (' || P_NR_PEDIDO || ') DA LOJA(' || P_NR_LOJA || ') ERRO:' ||SQLERRM);
END;


SET SERVEROUTPUT ON;
EXECUTE	PRC_DB_ATUALIZA_VL_TOT_PEDIDO( 1, 10);

SELECT NR_LOJA, NR_PEDIDO, VL_TOT_PEDIDO
FROM DB_PEDIDO 
WHERE NR_LOJA =1 AND NR_PEDIDO = 10;



SET SERVEROUTPUT ON;
DECLARE V_NR_lOJA NUMBER := 1;
		V_NR_PEDIDO NUMBER := 10;
BEGIN
	PRC_DB_ATUALIZA_VL_TOT_PEDIDO( V_NR_LOJA, V_NR_PEDIDO);
END;
/
