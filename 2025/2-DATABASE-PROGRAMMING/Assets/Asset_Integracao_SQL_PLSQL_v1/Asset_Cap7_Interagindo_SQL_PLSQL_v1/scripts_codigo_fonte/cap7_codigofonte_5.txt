--
-- Script que acesso o banco de dados Oracle 
-- e retorna o valor médio de vendas durante o ano corrente
-- PARA DETERMINADO CLIENTE
SET SERVEROUTPUT ON;
DECLARE
	V_NR_CLIENTE DB_CLIENTE.NR_CLIENTE%TYPE;
	
    V_VL_TOTAL_MEDIA_VENDAS 		NUMBER;
	
BEGIN

	V_NR_CLIENTE := &Informe_o_codigo_do_cliente;

    -- CONSULTA SQL DIRETAMENTE NO PL/SQL
	-- A média será arredondada para 2 casas decimais.
	--
    SELECT ROUND(AVG(VL_TOT_PEDIDO),2)
    INTO V_VL_TOTAL_MEDIA_VENDAS
    FROM  DB_PEDIDO
    WHERE EXTRACT(YEAR FROM DT_PEDIDO) = EXTRACT(YEAR FROM SYSDATE)
	AND	NR_CLIENTE = V_NR_CLIENTE;

	UPDATE DB_CLIENTE SET VL_MEDIO_COMPRA = V_VL_TOTAL_MEDIA_VENDAS 
	WHERE NR_CLIENTE = V_NR_CLIENTE;
	
	-- Confirma a transação
	COMMIT;

    DBMS_OUTPUT.PUT_LINE('VALOR MEDIO DE COMPRAS DO CLIENTE(' || V_NR_CLIENTE || ') PARA O ANO: ' || EXTRACT(YEAR FROM SYSDATE) || ' FOI DE R$' || V_VL_TOTAL_MEDIA_VENDAS );

END;
/

SELECT * FROM DB_CLIENTE WHERE NR_CLIENTE = 10;